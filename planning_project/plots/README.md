# Map Visualization

This directory contains Python scripts for visualizing the grid map generated by the planning node.

## Requirements

```bash
pip install matplotlib numpy
```

## Usage

### 1. Run the Planning Node

The planning node automatically saves:
- Grid map to `results/map.json` after building it
- Dubins trajectory to `results/trajectory.json` after path planning

```bash
# Terminal 1: Start simulation
roslaunch loco_planning multiple_robots.launch

# Terminal 2: Run planning node
rosrun planning_project planning_node
```

### 2. Visualize the Map

Once the map is saved, use the Python script to visualize it:

```bash
cd /path/to/planning_project/plots

# View map only (interactively)
python3 plot_map.py ../results/map.json

# View map with trajectory overlay
python3 plot_map.py ../results/map.json --trajectory ../results/trajectory.json

# Save to file
python3 plot_map.py ../results/map.json ../results/map_visualization.png

# Save map with trajectory
python3 plot_map.py ../results/map.json output.png --trajectory ../results/trajectory.json
```

## Visualization Features

The script generates visualizations with optional trajectory overlay:

### Map Visualization

#### 1. Standard Visualization (`plot_map()`)
- **Green cells**: Free space (robot can traverse)
- **Black cells**: Occupied (obstacles or outside borders)
- **Orange cells**: Mixed (boundary cells, only if not refined)
- Shows cell counts and map statistics

#### 2. Depth Visualization (`plot_map_with_depth()`)
- Color-codes free cells by subdivision depth
- Useful for understanding the quadtree refinement
- Automatically generated for refined maps when saving to file
- Saved as `*_depth.png`

### Trajectory Visualization (when `--trajectory` is provided)

When a trajectory file is provided, the following are overlaid on the map:

- **Blue line**: Dubins path (main trajectory)
- **Cyan thin lines**: Individual Dubins arc segments
- **Blue square**: Start position (with orientation arrow)
- **Red star**: Goal/Gate position (with orientation arrow)
- **Green circles**: Visited victims (with values)
- **Pink circles**: Unvisited victims (semi-transparent)
- **Yellow box**: Path statistics (distance, time, victims rescued)

## File Formats

### Map File Format (`map.json`)

```json
{
  "resolution": 0.5,
  "bounds": {
    "min_x": -5.0,
    "min_y": -5.0,
    "max_x": 5.0,
    "max_y": 5.0
  },
  "grid_size": {"width": 20, "height": 20},
  "refined": true,
  "cells": [
    {"x0": -5.0, "y0": -5.0, "x1": -4.5, "y1": -4.5, "state": "free", "depth": 0},
    ...
  ]
}
```

- **resolution**: Grid cell size in meters
- **bounds**: World coordinate limits
- **grid_size**: Original grid dimensions (before refinement)
- **refined**: Whether quadtree refinement was applied
- **cells**: Array of cell data
  - `x0, y0, x1, y1`: Cell bounds in world coordinates
  - `state`: "free", "occupied", or "mixed"
  - `depth`: Subdivision depth (0 = original grid cell, higher = more refined)

### Trajectory File Format (`trajectory.json`)

```json
{
  "start": {"x": 0.0, "y": 0.0, "theta": 0.0},
  "goal": {"x": 5.0, "y": 5.0, "theta": 1.57},
  "victims": [
    {"x": 1.0, "y": 1.0, "value": 100, "visited": true},
    {"x": 2.0, "y": 2.0, "value": 50, "visited": false}
  ],
  "route": [0, 2],
  "dubins_curves": [
    {
      "arcs": [
        {
          "start": {"x": 0.0, "y": 0.0, "theta": 0.0},
          "end": {"x": 1.0, "y": 1.0, "theta": 0.785},
          "k": 0.5,
          "length": 2.0
        },
        ...
      ]
    }
  ],
  "trajectory": [
    {"x": 0.0, "y": 0.0, "theta": 0.0, "time": 0.0},
    ...
  ],
  "stats": {
    "total_distance": 15.5,
    "total_time": 15.5,
    "num_victims_visited": 2
  }
}
```

- **start/goal**: Robot start and goal poses (x, y, theta)
- **victims**: All victims with their positions, values, and visited status
- **route**: Indices of visited victims in order
- **dubins_curves**: Dubins curve segments (each with 3 arcs: LSL, RSR, etc.)
- **trajectory**: Sampled trajectory points for smooth visualization
- **stats**: Summary statistics

## Examples

### Example 1: Quick visualization (map only)
```bash
python3 plot_map.py ../results/map.json
```

### Example 2: Visualize map with trajectory
```bash
python3 plot_map.py ../results/map.json --trajectory ../results/trajectory.json
```

### Example 3: Save high-quality figure with trajectory
```bash
python3 plot_map.py ../results/map.json ../results/map_with_path.png --trajectory ../results/trajectory.json
```

This will generate:
- `map_with_path.png` - Standard visualization with Dubins path
- `map_with_path_depth.png` - Depth visualization with path (if map is refined)

### Example 4: Create multiple outputs
```bash
# Map only
python3 plot_map.py ../results/map.json ../results/map_only.png

# Map with path
python3 plot_map.py ../results/map.json ../results/map_with_path.png --trajectory ../results/trajectory.json
```

## Customization

To customize the visualization, edit `plot_map.py`:

- **Colors**: Modify the `colors` and `edge_colors` dictionaries
- **Figure size**: Change `figsize=(12, 10)` in `plt.subplots()`
- **DPI**: Adjust `dpi=300` in `plt.savefig()`
- **Grid style**: Modify `ax.grid()` parameters

## Troubleshooting

**"File not found" error:**
- Make sure the planning node has run and created `results/map.json`
- Check the path is correct relative to your current directory

**Import errors:**
- Install matplotlib: `pip install matplotlib`
- Ensure you're using Python 3

**Empty or incorrect visualization:**
- Check that the map file is valid JSON
- Verify the planning node completed map building successfully
